---
title: "Exploratory data analysis"
author: "David F. Severski (@dseverski)"
date: "October 7, 2015"
output: 
  html_document: 
    toc: yes
---

Data is from the [Yelp dataset challenge](http://www.yelp.com/dataset_challenge)

Examples of the data are at https://github.com/Yelp/dataset-examples

```{r}
library(jsonlite)
library(dplyr)
library(lubridate)
library(ggplot2)
```

```{r read_from_json, eval=FALSE}
reviews <- stream_in(file("./data/yelp_academic_dataset_review.json"))
checkins <- stream_in(file("./data/yelp_academic_dataset_checkin.json"))
tips <- stream_in(file("./data/yelp_academic_dataset_tip.json"))
business <- stream_in(file("./data/yelp_academic_dataset_business.json"))
users <- stream_in(file("./data/yelp_academic_dataset_user.json"), verbose = TRUE)
```

```{r, read_from_rdata}
load('data/business.Rdata')
load('data/checkins.Rdata')
load('data/reviews.Rdata')
load('data/tips.Rdata')
load('data/users.Rdata')
```


```{r show_names, echo=FALSE}
names(business)
names(checkins)
names(reviews)
names(tips)
```

- Business has nested in attributes
- Checkins has an embeded frame in checkin_info
- Reviews has an embeded frame in votes
- Tips is a straight data frame
- Users is heavily nested

```{r, clean_data}
# votes data
votes <- rbind(reviews$votes)
votes$review_id <- reviews$review_id
reviews$date <- ymd(reviews$date)
reviews <- reviews[!names(reviews) %in% c("votes", "type")]

# checkins data
checkin_info <- rbind(checkins$checkin_info)
checkin_info$business_id <- checkins$business_id

# business data
attributes <- rbind(business$attributes)
#attributes$`Accepts Credit Cards` <- unlist(attributes$`Accepts Credit Cards`)
business <- select(business, -c(type))

# tips data
tips$date <- ymd(tips$date)
tips <- tips[!names(tips) %in% c("type")]

# users data
users$yelping_since <- ymd(paste0(users$yelping_since, "-01"))
```


All we really care about is `checkin_info`, which we link to the `business_id`

# Summarize Data

Review data summary is:
```{r  results='asis'}
knitr::kable(summary(reviews))
```

Tips data summary is:
```{r  results='asis'}
knitr::kable(summary(tips))
```

# Let's try some exploratory plots

## Business

Lots of data for a few states. AZ is particularly heavy.

```{r}
ggplot(business, aes(x=reorder(state, as.numeric(state), function(y) {-1*length(y)}))) +geom_bar()
```


## Common Cateogries
What are the most common categories?
```{r}
data.frame(categories = unlist(business$categories)) %>% 
  group_by(categories)  %>% tally()  %>% 
  arrange(desc(n)) %>% top_n(10)
data.frame(categories = unlist(business$categories)) %>% 
  group_by(categories)  %>% tally()  %>% 
  arrange(desc(n)) %>% top_n(25) %>% ggplot() -> gg
gg + geom_bar(aes(x=factor(categories, rev(as.character(categories))), y=n), 
              stat="identity") + coord_flip() + theme_minimal()

```


## Ratings of restaurants


```{r}
business$restaurants <- unlist(lapply(business$categories, function(x) {
  "Restaurants" %in% x}))
dat <- business[business$restaurants==TRUE, c('stars', 'state')]
ggplot(dat, aes(x=state, y=stars)) + geom_boxplot() +
  theme_minimal()
#+ geom_line(aes(y=mean(stars))
```

What are the most common categories associated with restaurants?
```{r}
dat <- business[business$restaurants==TRUE,]
data.frame(categories = unlist(dat$categories)) %>% 
  filter(categories != "Restaurants") %>% 
  group_by(categories)  %>% tally()  %>% 
  arrange(desc(n)) %>% top_n(20)
```

```{r}
business[business$review_count > 100,] %>% ggplot(aes(x=review_count)) + geom_histogram() + facet_wrap(~ state, scales = "free_y")
```

```{r}
library(maps)
library(mapproj)
us <- map_data("state")
ca <- map_data("world", "Canada")
fr <- map_data("france")

xlim = c(-110,-100)
ylim = c(40,60)
dat_grid = expand.grid(x = xlim[1]:xlim[2], y = ylim[1]:ylim[2])
dat_grid$z = runif(nrow(dat_grid))

gg <- ggplot()
gg <- gg + geom_point(data=business, aes(x=longitude, y=latitude, color=stars))
gg <- gg + geom_tile() + 
  geom_polygon(data=us, aes(x=long, y=lat, group=group), colour="black", fill="white", alpha=0) + 
  geom_polygon(data=ca, aes(x=long, y=lat, group=group), colour="black", fill="white", alpha=0) +
  geom_polygon(data=fr, aes(x=long, y=lat, group=group), colour="black", fill="white", alpha=0)
gg + coord_map("albers", at0= 45.5, lat1=29.5)
gg <- gg + theme_minimal()
gg
```

```{r}
table(business[business$longitude>-10,c("state")])
```